<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Xem Giá Thuốc — Upload hình ảnh trực tiếp</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 0; background-color: #f5f5f5; }
        .view-price-btn,.database-btn,.home-erp-btn,.notification-btn,.create-quote-btn{ position:fixed; right:20px; color:#fff; border:none; border-radius:8px; width:120px; height:50px; font-size:16px; font-weight:bold; cursor:pointer; box-shadow:0 4px 8px rgba(0,0,0,.2); display:flex; justify-content:center; align-items:center; text-align:center; transition:all .3s; z-index:1000; }
        .view-price-btn{ bottom:130px; background:#4285f4; } .view-price-btn:hover{ background:#3367d6; transform:scale(1.05); box-shadow:0 6px 12px rgba(0,0,0,.3)}
        .database-btn{ bottom:70px; background:#8e24aa; } .database-btn:hover{ background:#7b1fa2; transform:scale(1.05); box-shadow:0 6px 12px rgba(0,0,0,.3)}
        .home-erp-btn{ bottom:190px; background:#34a853; text-decoration:none } .home-erp-btn:hover{ background:#2d8e47; transform:scale(1.05); box-shadow:0 6px 12px rgba(0,0,0,.3)}
        .notification-btn{ bottom:250px; background:#f44336 } .notification-btn:hover{ background:#d32f2f; transform:scale(1.05); box-shadow:0 6px 12px rgba(0,0,0,.3)}
        .create-quote-btn{ bottom:310px; background:#ff9800 } .create-quote-btn:hover{ background:#f57c00; transform:scale(1.05); box-shadow:0 6px 12px rgba(0,0,0,.3)}

        .popup-overlay{ display:none; position:fixed; inset:0; background:rgba(0,0,0,.7); z-index:1001; overflow-y:auto }
        .popup-content{ background:#fff; margin:20px auto; padding:20px; width:90%; max-width:1200px; border-radius:8px; box-shadow:0 5px 15px rgba(0,0,0,.3); max-height:90vh; overflow-y:auto; position:relative }
        .popup-header{ display:flex; justify-content:space-between; align-items:center; margin-bottom:16px; padding-bottom:10px; border-bottom:1px solid #eee }
        .popup-title{ font-size:24px; color:#4285f4; margin:0 }
        .close-btn{ background:none; border:none; font-size:24px; cursor:pointer; color:#666 }

        .upload-section{ margin-bottom:16px; padding:15px; background:#f9f9f9; border-radius:5px; border:1px dashed #ccc }
        .file-input-container{ display:flex; align-items:center; gap:10px }
        .file-input-label{ padding:8px 15px; background:#4285f4; color:#fff; border-radius:4px; cursor:pointer; transition:.3s }
        .file-input-label:hover{ background:#3367d6 }
        .file-input{ display:none }
        .file-name{ flex-grow:1; color:#666 }

        .search-section{ margin-bottom:12px; display:flex; gap:8px; flex-wrap:wrap }
        .search-input{ flex:1; min-width:220px; padding:10px; border:1px solid #ddd; border-radius:4px; font-size:16px }
        .btn{ padding:10px 12px; border:none; border-radius:6px; font-weight:700; cursor:pointer }
        .btn-filter{ background:#8e24aa; color:#fff }
        .btn-clear{ background:#9e9e9e; color:#fff }

        .files-list{ margin-bottom:12px }
        .file-item{ display:flex; justify-content:space-between; align-items:center; padding:10px; background:#f5f5f5; margin-bottom:5px; border-radius:4px }
        .delete-file-btn{ background:#f44336; color:#fff; border:none; padding:5px 10px; border-radius:4px; cursor:pointer }

        .toolbar{ display:flex; flex-wrap:wrap; gap:8px; align-items:center; margin:12px 0; padding:10px; background:#f9fbff; border:1px solid #e3eeff; border-radius:6px }
        .toolbar .section-title{ font-weight:bold; color:#3367d6; margin-right:8px }
        .column-list{ display:flex; flex-wrap:wrap; gap:8px; max-height:120px; overflow:auto; border:1px dashed #cfe1ff; padding:8px; border-radius:6px; background:#fff }
        .column-chip{ display:inline-flex; align-items:center; gap:6px; background:#eef4ff; border:1px solid #cfe1ff; border-radius:999px; padding:6px 10px; font-size:13px }
        .toolbar button{ padding:8px 12px; border:none; border-radius:6px; cursor:pointer; font-weight:600 }
        .btn-hide{ background:#ff7043; color:#fff } .btn-unhide{ background:#43a047; color:#fff } .btn-showall{ background:#546e7a; color:#fff }

        .table-container{ overflow-x:auto; margin-top:12px }
        .price-table{ width:100%; border-collapse:collapse; table-layout: fixed; }
        .price-table th,.price-table td{ border:1px solid #ddd; padding:8px; text-align:left; white-space: normal; overflow-wrap: anywhere; word-break: break-word; }
        .price-table th{ background:#4285f4; color:#fff; position:sticky; top:0; z-index:1 }
        .price-table tr:nth-child(even){ background:#f2f2f2 }
        .price-table tr:hover{ background:#e6f2ff }
        .highlight{ background:yellow }
        .editing-cell { background-color: #fffde7; outline: 2px solid #ffc107; }


        /* Tay nắm kéo giãn cột */
        .th-resizable{ position: relative; }
        .col-resizer{ position:absolute; right:0; top:0; height:100%; width:6px; cursor:col-resize; user-select:none; -webkit-user-select:none; }
        .col-resizer:hover{ background: rgba(255,255,255,.25); }

        .loading{ display:none; text-align:center; margin:20px 0 }
        .spinner{ border:4px solid rgba(0,0,0,.1); border-radius:50%; border-top:4px solid #4285f4; width:30px; height:30px; animation:spin 1s linear infinite; margin:0 auto }

        .footer-actions{ display:flex; justify-content:flex-end; gap:10px; margin-top:16px; flex-wrap:wrap }
        .export-btn{ background:#1976d2; color:#fff; border:none; padding:10px 14px; border-radius:6px; font-weight:700; cursor:pointer }
        .export-btn:disabled { background-color: #ccc; cursor: not-allowed; }


        .password-dialog,.notification-dialog,.quote-dialog{ display:none; position:fixed; inset:0; background:rgba(0,0,0,.5); z-index:1002; justify-content:center; align-items:center }
        .password-dialog-content,.notification-dialog-content,.quote-dialog-content{ background:#fff; padding:20px; border-radius:8px; width:300px; box-shadow:0 5px 15px rgba(0,0,0,.3) }
        .notification-dialog-content,.quote-dialog-content{ width:400px }
        .password-dialog-title,.notification-dialog-title,.quote-dialog-title{ font-size:18px; margin-bottom:15px }
        .password-input,.notification-textarea,.quote-input{ width:100%; padding:10px; margin-bottom: 10px; box-sizing: border-box; border:1px solid #ddd; border-radius:4px; font-size:16px }
        .notification-textarea{ height:150px; margin-bottom:15px; resize:vertical }
        .password-dialog-buttons,.notification-dialog-buttons,.quote-dialog-buttons{ display:flex; justify-content:flex-end; gap:10px; margin-top: 10px; }
        .password-dialog-cancel{ background:#f5f5f5 } .password-dialog-confirm{ background:#4285f4; color:#fff }
        .notification-dialog-cancel{ background:#f5f5f5 } .notification-dialog-save{ background:#4CAF50; color:#fff }
        .quote-dialog-cancel{ background:#f5f5f5 } .quote-dialog-create{ background:#ff9800; color:#fff }
        .notification-display{ position:fixed; top:20px; left:50%; transform:translateX(-50%); background:#ffebee; border:1px solid #f44336; border-radius:4px; padding:15px; max-width:80%; color:#f44336; font-weight:bold; z-index:1000; display:none; text-align:center }

        /* Image manager */
        .image-manager { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); z-index: 1003; width: 500px; max-width: 90%; }
        .image-manager h3 { margin-top: 0; color: #4285f4; }
        .image-url-input { width: 100%; padding: 10px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 4px; }
        .image-manager-buttons { display: flex; justify-content: flex-end; gap: 10px; margin-top: 15px; }
        .image-manager-cancel { background: #f5f5f5; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; }
        .image-manager-save { background: #4285f4; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; }
        .image-preview { max-width: 100%; max-height: 200px; margin-top: 10px; display: none; border: 1px solid #eee; border-radius: 4px; }
        .upload-section-image { margin: 15px 0; padding: 15px; border: 2px dashed #ccc; border-radius: 5px; text-align: center; background: #f9f9f9; }
        .upload-image-btn { background: #ff9800; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; margin-top: 10px; }
        .upload-image-btn:hover { background: #f57c00; }
        .upload-status { margin-top: 10px; font-size: 14px; color: #666; }
        .tab-container { display: flex; border-bottom: 1px solid #ddd; margin-bottom: 15px; }
        .tab { padding: 10px 15px; cursor: pointer; border-bottom: 2px solid transparent; }
        .tab.active { border-bottom: 2px solid #4285f4; color: #4285f4; font-weight: bold; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* Quote page styles */
        .quote-page { 
            display: none; 
            background: white; 
            padding: 20px; 
            margin: 20px auto; 
            max-width: 1000px; 
            box-shadow: 0 0 10px rgba(0,0,0,0.1); 
            page-break-after: always;
        }
        .quote-header { 
            display: flex; 
            margin-bottom: 20px; 
            flex-direction: column;
        }
        .company-logo-container {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }
        .company-logo { 
            width: 80px; 
            height: auto;
            margin-right: 20px;
        }
        .company-info { 
            text-align: left;
            font-size: 14px;
            line-height: 1.5;
        }
        .quote-title { 
            text-align: center; 
            font-size: 24px; 
            font-weight: bold; 
            margin: 20px 0; 
            color: #4285f4; 
            text-transform: uppercase;
        }
        .customer-info { 
            margin-bottom: 20px; 
            padding: 15px; 
            background: #f9f9f9; 
            border-radius: 5px; 
            border: 1px solid #ddd;
        }
        .customer-info-row { 
            display: flex; 
            margin-bottom: 10px; 
            font-size: 14px;
        }
        .customer-info-label { 
            width: 150px; 
            font-weight: bold; 
        }
        .quote-table { 
            width: 100%; 
            border-collapse: collapse; 
            margin-top: 20px; 
            font-size: 14px;
        }
        .quote-table th, .quote-table td { 
            border: 1px solid #ddd; 
            padding: 8px; 
            text-align: left; 
            vertical-align: top;
        }
        .quote-table th { 
            background: #4285f4; 
            color: white; 
        }
        .product-image { 
            max-width: 80px; 
            max-height: 80px; 
            display: block; 
            margin-bottom: 5px;
            border: 1px solid #eee;
            border-radius: 4px;
        }
        .quote-footer { 
            margin-top: 30px; 
            display: flex; 
            justify-content: space-between; 
            font-size: 14px;
        }
        .quote-actions { 
            margin-top: 20px; 
            text-align: center; 
            padding: 20px 0;
        }
        .quote-back-btn { 
            background: #4285f4; 
            color: white; 
            border: none; 
            padding: 10px 20px; 
            border-radius: 5px; 
            cursor: pointer; 
            margin-right: 10px; 
        }
        .quote-print-btn { 
            background: #34a853; 
            color: white; 
            border: none; 
            padding: 10px 20px; 
            border-radius: 5px; 
            cursor: pointer; 
            margin-right: 10px;
        }
        .quote-pdf-btn {
            background: #f44336; 
            color: white; 
            border: none; 
            padding: 10px 20px; 
            border-radius: 5px; 
            cursor: pointer;
        }

        /* For PDF printing */
        @media print {
            body * {
                visibility: hidden;
            }
            .quote-page, .quote-page * {
                visibility: visible;
            }
            .quote-page {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                margin: 0;
                padding: 20px;
                box-shadow: none;
            }
            .quote-actions {
                display: none !important;
            }
        }

        @keyframes spin{ 0%{ transform:rotate(0) } 100%{ transform:rotate(360deg) } }
        @media(max-width:768px){ 
            .popup-content{ width:95%; padding:15px } 
            .price-table{ font-size:14px } 
            .view-price-btn,.database-btn,.home-erp-btn,.notification-btn,.create-quote-btn{ width:60px; height:60px; font-size:14px } 
            .database-btn { bottom: 70px }
            .view-price-btn { bottom: 130px }
            .home-erp-btn{ bottom:190px } 
            .notification-btn{ bottom:250px } 
            .create-quote-btn{ bottom:310px }
            .notification-dialog-content,.quote-dialog-content{ width:90% } 
            .notification-display{ top:10px; max-width:95%; font-size:14px; padding:10px } 
            .customer-info-row { flex-direction: column; }
            .customer-info-label { width: 100%; margin-bottom: 5px; }
            .image-manager { width: 95%; padding: 15px; }
        }
        
        /* Selected products filter */
        .selected-products-filter {
            margin: 10px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .selected-products-filter label {
            font-weight: bold;
            color: #4285f4;
        }
		/* Thêm style mới cho tính năng tách nền và xóa ảnh */
        .image-processing-controls {
            margin-top: 15px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .processing-btn {
            padding: 8px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
        }
        
        .remove-bg-btn {
            background: #9c27b0;
            color: white;
        }
        
        .remove-bg-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .remove-image-btn {
            background: #f44336;
            color: white;
        }
        
        .processing-status {
            margin-top: 10px;
            padding: 8px;
            border-radius: 4px;
            display: none;
        }
        
        .processing-status.loading {
            display: block;
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        .processing-status.success {
            display: block;
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .processing-status.error {
            display: block;
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
    </style>
</head>
<body>
    <button class="notification-btn" id="notificationBtn">Thông báo</button>
    <a href="https://erp-ideco.skyit.vn/#/app/order/index/" class="home-erp-btn" id="homeErpBtn">HOME ERP</a>
    <button class="view-price-btn" id="viewPriceBtn">Xem Giá</button>
    <button class="database-btn" id="databaseBtn">Cơ sở dữ liệu</button>
    <button class="create-quote-btn" id="createQuoteBtn">Tạo Báo Giá</button>

    <div class="notification-display" id="notificationDisplay"></div>

    <div class="notification-dialog" id="notificationDialog">
        <div class="notification-dialog-content">
            <div class="notification-dialog-title">THÔNG BÁO SẢN PHẨM</div>
            <textarea class="notification-textarea" id="notificationTextarea" placeholder="Nhập thông báo sản phẩm..."></textarea>
            <div class="notification-dialog-buttons">
                <button class="notification-dialog-cancel" id="notificationCancelBtn">Hủy</button>
                <button class="notification-dialog-save" id="notificationSaveBtn">Lưu</button>
            </div>
        </div>
    </div>

    <div class="popup-overlay" id="popupOverlay">
        <div class="popup-content">
            <div class="popup-header">
                <h2 class="popup-title">Xem Giá Thuốc</h2>
                <button class="close-btn" id="closePopupBtn">&times;</button>
            </div>

            <div class="upload-section">
                <div class="file-input-container">
                    <label for="excelFileInput" class="file-input-label">Chọn file Excel</label>
                    <input type="file" id="excelFileInput" class="file-input" accept=".xlsx, .xls" multiple />
                    <span class="file-name" id="fileNameDisplay">Chưa chọn file</span>
                </div>
            </div>

            <div class="search-section">
                <input type="text" id="searchInput" class="search-input" placeholder="Tìm kiếm trong bảng giá..." />
                <button class="btn btn-filter" id="filterSelectedBtn" title="Chỉ hiển thị các hàng đã tick">Lọc hàng đã chọn</button>
                <button class="btn btn-clear" id="clearSelectionBtn" title="Xóa mọi tick và trở về danh sách ban đầu">Refresh (xóa chọn)</button>
            </div>

            <div class="toolbar" id="columnToolbar" style="display:none">
                <span class="section-title">Chọn cột:</span>
                <div class="column-list" id="columnList"></div>
                <button class="btn-hide" id="btnHide">Ẩn cột đã chọn</button>
                <button class="btn-unhide" id="btnUnhide">Hiện cột đã chọn</button>
                <button class="btn-showall" id="btnShowAll">Hiện tất cả</button>
            </div>

            <div class="files-list" id="filesList"></div>

            <div class="loading" id="loadingIndicator">
                <div class="spinner"></div>
                <p>Đang tải dữ liệu...</p>
            </div>

            <div class="table-container" id="tableContainer"></div>

            <div class="footer-actions">
                <button class="export-btn" id="addNewRowBtn" style="background: #4caf50;">Thêm hàng mới</button>
                <button class="export-btn" id="editRowBtn" style="background: #ffc107;" disabled>Sửa hàng đã chọn</button>
                <button class="export-btn" id="deleteRowBtn" style="background: #f44336;" disabled>Xóa hàng đã chọn</button>
                <button class="export-btn" id="exportBtn">Xuất Excel theo giao diện hiện tại</button>
                <button class="export-btn" id="manageImagesBtn" style="background: #9c27b0;">Quản lý hình ảnh</button>
            </div>
        </div>
    </div>
    
    <div class="popup-overlay" id="customerDbOverlay">
        <div class="popup-content">
            <div class="popup-header">
                <h2 class="popup-title" style="color:#8e24aa">Cơ sở dữ liệu khách hàng</h2>
                <button class="close-btn" id="closeDbPopupBtn">&times;</button>
            </div>
            <div class="upload-section">
                <div class="file-input-container">
                    <label for="customerFileInput" class="file-input-label" style="background-color:#8e24aa;">Upload file khách hàng</label>
                    <input type="file" id="customerFileInput" class="file-input" accept=".xlsx, .xls" />
                    <span class="file-name" id="customerFileNameDisplay">Chưa chọn file</span>
                </div>
                 <small style="display:block; margin-top:10px; color: #666;">File Excel cần có các cột: Tên khách hàng, Người phụ trách, Điện thoại, Địa chỉ.</small>
            </div>
            <div class="loading" id="customerLoadingIndicator">
                <div class="spinner"></div>
                <p>Đang tải dữ liệu khách hàng...</p>
            </div>
            <div class="table-container" id="customerTableContainer"></div>
        </div>
    </div>


    <div class="password-dialog" id="passwordDialog">
        <div class="password-dialog-content">
            <div class="password-dialog-title">Nhập password để xóa file</div>
            <input type="password" class="password-input" id="passwordInput" placeholder="Nhập password..." />
            <div class="password-dialog-buttons">
                <button class="password-dialog-cancel" id="passwordDialogCancel">Hủy</button>
                <button class="password-dialog-confirm" id="passwordDialogConfirm">Xác nhận</button>
            </div>
        </div>
    </div>

    <div class="quote-dialog" id="quoteDialog">
        <div class="quote-dialog-content">
            <div class="quote-dialog-title">THÔNG TIN KHÁCH HÀNG</div>
            <input type="text" class="quote-input" id="customerNameInput" placeholder="Tên khách hàng" list="customerSuggestions" autocomplete="off" />
            <datalist id="customerSuggestions"></datalist>
            <input type="text" class="quote-input" id="customerContactInput" placeholder="Người phụ trách" />
            <input type="text" class="quote-input" id="customerPhoneInput" placeholder="Điện thoại" />
            <input type="text" class="quote-input" id="customerAddressInput" placeholder="Địa chỉ" />
            <div class="quote-dialog-buttons">
                <button class="quote-dialog-cancel" id="quoteDialogCancel">Hủy</button>
                <button class="quote-dialog-create" id="quoteDialogCreate">Tạo Báo Giá</button>
            </div>
        </div>
    </div>

   <div class="image-manager" id="imageManager">
        <h3>Quản lý hình ảnh sản phẩm</h3>
        
        <div class="selected-products-filter">
            <label>
                <input type="checkbox" id="showOnlySelectedProducts" checked />
                Chỉ hiển thị sản phẩm đã chọn
            </label>
        </div>
        
        <div>
            <label for="productSelect">Chọn sản phẩm:</label>
            <select id="productSelect" class="quote-input"></select>
        </div>
        
        <div class="tab-container">
            <div class="tab active" data-tab="url-tab">Dán URL</div>
            <div class="tab" data-tab="upload-tab">Upload từ máy tính</div>
        </div>
        
        <div class="tab-content active" id="url-tab">
            <div style="margin-top: 15px;">
                <label for="imageUrlInput">URL hình ảnh:</label>
                <input type="text" id="imageUrlInput" class="image-url-input" placeholder="Dán URL hình ảnh tại đây..." />
                <button id="previewImageBtn" style="margin-top: 10px; padding: 5px 10px; background: #2196F3; color: white; border: none; border-radius: 4px; cursor: pointer;">Xem trước</button>
            </div>
        </div>
        
        <div class="tab-content" id="upload-tab">
            <div class="upload-section-image">
                <p>Chọn hình ảnh từ máy tính của bạn:</p>
                <input type="file" id="imageUploadInput" accept="image/*" style="display: none;" />
                <button class="upload-image-btn" id="triggerUploadBtn">Chọn hình ảnh</button>
                <div class="upload-status" id="uploadStatus"></div>
                
                <div class="image-processing-controls">
                    <button class="processing-btn remove-bg-btn" id="removeBgBtn" disabled>Tách nền tự động</button>
                    <button class="processing-btn remove-image-btn" id="removeImageBtn">Xóa hình và làm lại</button>
                    <div class="processing-status" id="processingStatus"></div>
                </div>
            </div>
        </div>
        
        <img id="imagePreview" class="image-preview" />
        
        <div class="image-manager-buttons">
            <button class="image-manager-cancel" id="imageManagerCancel">Hủy</button>
            <button class="image-manager-save" id="imageManagerSave">Lưu hình ảnh</button>
        </div>
    </div>

    <div class="quote-page" id="quotePage">
        <div class="quote-header">
            <div class="company-logo-container">
                <img src="https://cdn.imgpile.com/f/GK3nMDF_xl.png" alt="Company Logo" class="company-logo" />
                <div class="company-info">
                    <div><strong>CÔNG TY TNHH TM -DV KẾT GIAO PHÁT TRIỂN QUỐC TẾ ( IDECO)</strong></div>
                    <div>Địa chỉ:003 Carillon 5 262/3 Lũy Bán Bích -P.Tân Phú -Tp.HCM</div>
                    <div>Điện thoại: 0385400436</div>
                    <div>www.goibaogia.com</div>
                </div>
            </div>
        </div>
        
        <div class="quote-title">BÁO GIÁ SẢN PHẨM THUỐC</div>
        
        <div class="customer-info">
            <div class="customer-info-row">
                <div class="customer-info-label">Khách hàng:</div>
                <div id="quoteCustomerName"></div>
            </div>
            <div class="customer-info-row">
                <div class="customer-info-label">Người phụ trách:</div>
                <div id="quoteCustomerContact"></div>
            </div>
            <div class="customer-info-row">
                <div class="customer-info-label">Điện thoại:</div>
                <div id="quoteCustomerPhone"></div>
            </div>
            <div class="customer-info-row">
                <div class="customer-info-label">Địa chỉ:</div>
                <div id="quoteCustomerAddress"></div>
            </div>
        </div>
        
        <div class="table-container" id="quoteTableContainer"></div>
        
       <div class="quote-footer">
            <div>
                <div style="font-style: italic; font-weight: bold;">Gía này chưa bao gồm VAT 5%</div>
            </div>
            <div>
                <div>Ngày lập: <span id="quoteDate"></span></div>
                <div style="margin-top: 50px; text-align: center;">CÔNG TY IDECO TRÂN TRỌNG BÁO </div>
                <div style="margin-top: 50px; text-align: center; font-weight: bold;">(Ký và ghi rõ họ tên)</div>
                
            </div>
        </div>
        
        <div class="quote-actions">
            <button class="quote-back-btn" id="quoteBackBtn">Quay lại</button>
            <button class="quote-print-btn" id="quotePrintBtn">In Báo Giá</button>
            <button class="quote-pdf-btn" id="quotePdfBtn">Xuất PDF</button>
        </div>
    </div>

<script>
    // ========== Firebase ==========
    const firebaseConfig = {
        apiKey: "AIzaSyBuXjYpTuKpNyZY6ZIfUSA-m4NWBwPWcU0",
        authDomain: "baica-dae2b.firebaseapp.com",
        databaseURL: "https://baica-dae2b-default-rtdb.firebaseio.com",
        projectId: "baica-dae2b",
        storageBucket: "baica-dae2b.appspot.com",
        messagingSenderId: "61139094665",
        appId: "1:61139094665:web:13ebec976cec24e53f8a58",
        measurementId: "G-VN2S2VVSZB",
    };
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    // ========== Biến toàn cục ==========
    let uploadedFiles = [];
    let currentData = [];           // mảng AoA, index của phần tử chính là ID hàng toàn cục
    let fileIndexToRemove = null;
    const CORRECT_PASSWORD = "minhtriet1973";
    let customerDatabase = []; // NEW: To store customer data

    // Cột
    let hiddenColumns = new Set(); // index cột đang ẩn
    let headersCache = [];         // tiêu đề
    let columnWidths = {};         // {colIndex: widthPx}

    // Hàng được chọn
    const selectedRowIdx = new Set(); // lưu chỉ số hàng theo currentData (ID ổn định)
    let showingOnlySelected = false;  // trạng thái lọc xem chỉ hàng đã chọn

    // Hình ảnh sản phẩm
    let productImages = {};        // {productName: imageData (base64 hoặc URL)}
    let currentImageFile = null;   // File hình ảnh được chọn để upload
    let originalImageFile = null;  // File gốc để có thể làm lại

    // --- Biến mới cho chức năng CRUD ---
    let rowIndexMap = []; // Map từ index của currentData về {fileIndex, rowIndexInFile}
    let editingRowState = { index: null, originalData: [] }; // Lưu trạng thái hàng đang sửa


    // API Remove.bg - cần thay bằng API key thực
    const REMOVE_BG_API_KEY = "iHt8DKCwKg4Va63ACXopN7nm"; // Thay bằng API key thực

    // ========== DOM ==========
    const viewPriceBtn = document.getElementById("viewPriceBtn");
    const popupOverlay = document.getElementById("popupOverlay");
    const closePopupBtn = document.getElementById("closePopupBtn");
    const excelFileInput = document.getElementById("excelFileInput");
    const fileNameDisplay = document.getElementById("fileNameDisplay");
    const filesList = document.getElementById("filesList");
    const searchInput = document.getElementById("searchInput");
    const tableContainer = document.getElementById("tableContainer");
    const loadingIndicator = document.getElementById("loadingIndicator");

    const passwordDialog = document.getElementById("passwordDialog");
    const passwordInput = document.getElementById("passwordInput");
    const passwordDialogCancel = document.getElementById("passwordDialogCancel");
    const passwordDialogConfirm = document.getElementById("passwordDialogConfirm");

    const notificationBtn = document.getElementById("notificationBtn");
    const notificationDialog = document.getElementById("notificationDialog");
    const notificationTextarea = document.getElementById("notificationTextarea");
    const notificationCancelBtn = document.getElementById("notificationCancelBtn");
    const notificationSaveBtn = document.getElementById("notificationSaveBtn");
    const notificationDisplay = document.getElementById("notificationDisplay");

    const columnToolbar = document.getElementById("columnToolbar");
    const columnList = document.getElementById("columnList");
    const btnHide = document.getElementById("btnHide");
    const btnUnhide = document.getElementById("btnUnhide");
    const btnShowAll = document.getElementById("btnShowAll");
    const exportBtn = document.getElementById("exportBtn");
    const manageImagesBtn = document.getElementById("manageImagesBtn");

    const filterSelectedBtn = document.getElementById("filterSelectedBtn");
    const clearSelectionBtn = document.getElementById("clearSelectionBtn");

    const createQuoteBtn = document.getElementById("createQuoteBtn");
    const quoteDialog = document.getElementById("quoteDialog");
    const customerNameInput = document.getElementById("customerNameInput");
    const customerContactInput = document.getElementById("customerContactInput");
    const customerPhoneInput = document.getElementById("customerPhoneInput");
    const customerAddressInput = document.getElementById("customerAddressInput");
    const quoteDialogCancel = document.getElementById("quoteDialogCancel");
    const quoteDialogCreate = document.getElementById("quoteDialogCreate");
    const customerSuggestions = document.getElementById('customerSuggestions');


    const imageManager = document.getElementById("imageManager");
    const productSelect = document.getElementById("productSelect");
    const imageUrlInput = document.getElementById("imageUrlInput");
    const imagePreview = document.getElementById("imagePreview");
    const previewImageBtn = document.getElementById("previewImageBtn");
    const imageManagerCancel = document.getElementById("imageManagerCancel");
    const imageManagerSave = document.getElementById("imageManagerSave");
    const imageUploadInput = document.getElementById("imageUploadInput");
    const triggerUploadBtn = document.getElementById("triggerUploadBtn");
    const uploadStatus = document.getElementById("uploadStatus");
    const tabs = document.querySelectorAll('.tab');
    const tabContents = document.querySelectorAll('.tab-content');
    const showOnlySelectedCheckbox = document.getElementById("showOnlySelectedProducts");

    const quotePage = document.getElementById("quotePage");
    const quoteCustomerName = document.getElementById("quoteCustomerName");
    const quoteCustomerContact = document.getElementById("quoteCustomerContact");
    const quoteCustomerPhone = document.getElementById("quoteCustomerPhone");
    const quoteCustomerAddress = document.getElementById("quoteCustomerAddress");
    const quoteDate = document.getElementById("quoteDate");
    const quoteTableContainer = document.getElementById("quoteTableContainer");
    const quoteBackBtn = document.getElementById("quoteBackBtn");
    const quotePrintBtn = document.getElementById("quotePrintBtn");
    const quotePdfBtn = document.getElementById("quotePdfBtn");

    // Thêm các phần tử DOM mới cho xử lý ảnh
    const removeBgBtn = document.getElementById("removeBgBtn");
    const removeImageBtn = document.getElementById("removeImageBtn");
    const processingStatus = document.getElementById("processingStatus");

    // --- DOM mới cho CRUD ---
    const addNewRowBtn = document.getElementById("addNewRowBtn");
    const editRowBtn = document.getElementById("editRowBtn");
    const deleteRowBtn = document.getElementById("deleteRowBtn");

    // --- DOM MỚI CHO DATABASE KHÁCH HÀNG ---
    const databaseBtn = document.getElementById("databaseBtn");
    const customerDbOverlay = document.getElementById("customerDbOverlay");
    const closeDbPopupBtn = document.getElementById("closeDbPopupBtn");
    const customerFileInput = document.getElementById("customerFileInput");
    const customerFileNameDisplay = document.getElementById("customerFileNameDisplay");
    const customerTableContainer = document.getElementById("customerTableContainer");
    const customerLoadingIndicator = document.getElementById("customerLoadingIndicator");


    // ========== Sự kiện ==========
    viewPriceBtn.addEventListener("click", () => {
        popupOverlay.style.display = "block";
        loadDataFromFirebase();
    });
    closePopupBtn.addEventListener("click", () => (popupOverlay.style.display = "none"));
    popupOverlay.addEventListener("click", (e) => { if (e.target === popupOverlay) popupOverlay.style.display = "none"; });
    excelFileInput.addEventListener("change", handleFileSelect);
    searchInput.addEventListener("input", ()=>{ showingOnlySelected=false; performSearch(); });

    passwordDialogCancel.addEventListener("click", () => { passwordDialog.style.display = "none"; passwordInput.value = ""; fileIndexToRemove = null; });
    passwordDialogConfirm.addEventListener("click", () => {
        const enteredPassword = passwordInput.value;
        if (enteredPassword === CORRECT_PASSWORD) {
            if (fileIndexToRemove !== null) removeFile(fileIndexToRemove);
            passwordDialog.style.display = "none"; passwordInput.value = ""; fileIndexToRemove = null;
        } else { alert("Password không đúng. Vui lòng thử lại."); passwordInput.value = ""; }
    });

    notificationBtn.addEventListener("click", () => {
        notificationDialog.style.display = "flex";
        notificationTextarea.focus();
        database.ref("notification").once("value").then((snapshot) => {
            const data = snapshot.val(); if (data && data.text) notificationTextarea.value = data.text;
        });
    });
    notificationCancelBtn.addEventListener("click", () => { notificationDialog.style.display = "none"; notificationDisplay.style.display = "none"; });
    notificationSaveBtn.addEventListener("click", saveNotification);

    btnHide.addEventListener("click", () => applyColumnSelection("hide"));
    btnUnhide.addEventListener("click", () => applyColumnSelection("unhide"));
    btnShowAll.addEventListener("click", () => { hiddenColumns.clear(); renderColumnSelector(); redrawWithFilters(); });

    exportBtn.addEventListener("click", exportCurrentViewToExcel);
    manageImagesBtn.addEventListener("click", openImageManager);

    filterSelectedBtn.addEventListener('click', ()=>{ if(selectedRowIdx.size===0){ alert('Chưa có hàng nào được chọn.'); return; } showingOnlySelected=true; renderSelectedOnly(); });
    clearSelectionBtn.addEventListener('click', ()=>{ selectedRowIdx.clear(); showingOnlySelected=false; searchInput.value=''; createTable(currentData); updateActionButtonsState(); });

    createQuoteBtn.addEventListener('click', () => {
        if (selectedRowIdx.size === 0) {
            alert('Vui lòng chọn ít nhất một sản phẩm để tạo báo giá.');
            return;
        }
        quoteDialog.style.display = 'flex';
        customerNameInput.focus();
    });

    quoteDialogCancel.addEventListener('click', () => {
        quoteDialog.style.display = 'none';
        clearQuoteForm();
    });

    quoteDialogCreate.addEventListener('click', createQuote);

    // Sự kiện cho autocomplete khách hàng
    customerNameInput.addEventListener('input', showCustomerSuggestions);

    quoteBackBtn.addEventListener('click', () => {
        quotePage.style.display = 'none';
        popupOverlay.style.display = 'block';
    });

    quotePrintBtn.addEventListener('click', () => {
        window.print();
    });

    quotePdfBtn.addEventListener('click', generatePdf);

    previewImageBtn.addEventListener('click', previewImage);
    imageManagerCancel.addEventListener('click', () => { 
        imageManager.style.display = 'none'; 
        imageUrlInput.value = '';
        imagePreview.style.display = 'none';
        currentImageFile = null;
        originalImageFile = null;
        uploadStatus.textContent = '';
        resetProcessingUI();
    });
    imageManagerSave.addEventListener('click', saveProductImage);
    
    triggerUploadBtn.addEventListener('click', () => {
        imageUploadInput.click();
    });
    
    imageUploadInput.addEventListener('change', handleImageUpload);
    
    // Tab switching
    tabs.forEach(tab => {
        tab.addEventListener('click', () => {
            const tabId = tab.getAttribute('data-tab');
            
            tabs.forEach(t => t.classList.remove('active'));
            tabContents.forEach(tc => tc.classList.remove('active'));
            
            tab.classList.add('active');
            document.getElementById(tabId).classList.add('active');
        });
    });

    showOnlySelectedCheckbox.addEventListener('change', () => {
        if (imageManager.style.display === 'block') {
            populateProductSelect();
        }
    });

    removeBgBtn.addEventListener("click", removeImageBackground);
    removeImageBtn.addEventListener("click", resetImageUpload);

    // --- Sự kiện mới cho CRUD ---
    addNewRowBtn.addEventListener("click", handleAddNewRow);
    editRowBtn.addEventListener("click", handleEditRow);
    deleteRowBtn.addEventListener("click", handleDeleteRows);
    
    // --- SỰ KIỆN MỚI CHO DATABASE KHÁCH HÀNG ---
    databaseBtn.addEventListener("click", () => {
        customerDbOverlay.style.display = "block";
        renderCustomerTable(customerDatabase); // Hiển thị dữ liệu đã tải
    });
    closeDbPopupBtn.addEventListener("click", () => customerDbOverlay.style.display = "none");
    customerDbOverlay.addEventListener("click", (e) => { if (e.target === customerDbOverlay) customerDbOverlay.style.display = "none"; });
    customerFileInput.addEventListener("change", handleCustomerFileSelect);

    // ========== Customer Database Functions (NEW) ==========

    async function handleCustomerFileSelect(event) {
        const file = event.target.files[0];
        if (!file) return;

        customerLoadingIndicator.style.display = "block";
        customerTableContainer.innerHTML = "";
        customerFileNameDisplay.textContent = file.name;

        try {
            const data = await readExcelFile(file);
            if (data.length < 2) {
                throw new Error("File Excel không có dữ liệu hoặc chỉ có dòng tiêu đề.");
            }

            const header = data[0].map(h => String(h).toLowerCase().trim());
            const nameIndex = header.findIndex(h => h.includes('tên khách hàng') || h.includes('tên'));
            const contactIndex = header.findIndex(h => h.includes('người phụ trách'));
            const phoneIndex = header.findIndex(h => h.includes('điện thoại') || h.includes('sdt'));
            const addressIndex = header.findIndex(h => h.includes('địa chỉ'));

            if (nameIndex === -1) {
                throw new Error("Không tìm thấy cột 'Tên khách hàng' trong file Excel.");
            }

            const parsedData = data.slice(1).map(row => ({
                tenKhachHang: row[nameIndex] || '',
                nguoiPhuTrach: contactIndex > -1 ? (row[contactIndex] || '') : '',
                dienThoai: phoneIndex > -1 ? (row[phoneIndex] || '') : '',
                diaChi: addressIndex > -1 ? (row[addressIndex] || '') : '',
            })).filter(customer => customer.tenKhachHang.trim() !== ''); // Lọc bỏ khách hàng không có tên

            customerDatabase = parsedData;
            await saveCustomerDataToFirebase();
            renderCustomerTable(customerDatabase);
            alert(`Đã import và lưu thành công ${customerDatabase.length} khách hàng.`);

        } catch (error) {
            console.error("Lỗi khi xử lý file khách hàng:", error);
            alert(`Lỗi: ${error.message}`);
            customerTableContainer.innerHTML = `<p style="color:red;">Lỗi khi xử lý file: ${error.message}</p>`;
        } finally {
            customerLoadingIndicator.style.display = "none";
            customerFileInput.value = ''; // Reset input
        }
    }
    
    function renderCustomerTable(data) {
        if (!data || data.length === 0) {
            customerTableContainer.innerHTML = '<p>Không có dữ liệu khách hàng. Vui lòng upload file Excel.</p>';
            return;
        }

        const table = document.createElement("table");
        table.className = "price-table";
        const thead = document.createElement("thead");
        const headerRow = document.createElement("tr");

        const headers = ["STT", "Tên khách hàng", "Người phụ trách", "Điện thoại", "Địa chỉ"];
        headers.forEach(text => {
            const th = document.createElement("th");
            th.textContent = text;
            headerRow.appendChild(th);
        });
        thead.appendChild(headerRow);
        table.appendChild(thead);

        const tbody = document.createElement("tbody");
        data.forEach((customer, index) => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
                <td>${index + 1}</td>
                <td>${customer.tenKhachHang || ''}</td>
                <td>${customer.nguoiPhuTrach || ''}</td>
                <td>${customer.dienThoai || ''}</td>
                <td>${customer.diaChi || ''}</td>
            `;
            tbody.appendChild(tr);
        });
        table.appendChild(tbody);

        customerTableContainer.innerHTML = "";
        customerTableContainer.appendChild(table);
    }

    async function saveCustomerDataToFirebase() {
        try {
            await database.ref("customerData").set(customerDatabase);
            console.log("Đã lưu dữ liệu khách hàng lên Firebase.");
        } catch (err) {
            console.error("Lỗi khi lưu dữ liệu khách hàng:", err);
            alert("Lỗi khi lưu dữ liệu khách hàng. Vui lòng kiểm tra kết nối mạng.");
        }
    }

    async function loadCustomerDataFromFirebase() {
        try {
            const snapshot = await database.ref('customerData').once('value');
            const data = snapshot.val();
            if (data && Array.isArray(data)) {
                customerDatabase = data;
                console.log(`Đã tải ${customerDatabase.length} khách hàng từ Firebase.`);
            }
        } catch (error) {
            console.error('Lỗi khi tải dữ liệu khách hàng:', error);
        }
    }
    
    function showCustomerSuggestions(event) {
        const input = event.target.value.toLowerCase();
        customerSuggestions.innerHTML = '';

        if (input.length < 1) {
            return;
        }

        const filteredCustomers = customerDatabase.filter(customer =>
            customer.tenKhachHang.toLowerCase().includes(input)
        );

        filteredCustomers.forEach(customer => {
            const option = document.createElement('option');
            option.value = customer.tenKhachHang;
            customerSuggestions.appendChild(option);
        });
        
        // Auto-fill when a selection is made
        const exactMatch = customerDatabase.find(c => c.tenKhachHang.toLowerCase() === input);
        if (exactMatch) {
            customerContactInput.value = exactMatch.nguoiPhuTrach || '';
            customerPhoneInput.value = exactMatch.dienThoai || '';
            customerAddressInput.value = exactMatch.diaChi || '';
        }
    }


    // ========== CRUD Functions (Thêm, Sửa, Xóa) ==========
    
    function updateActionButtonsState() {
        if (editingRowState.index !== null) {
            addNewRowBtn.disabled = true;
            deleteRowBtn.disabled = true;
            editRowBtn.disabled = false;
        } else {
            addNewRowBtn.disabled = false;
            deleteRowBtn.disabled = (selectedRowIdx.size === 0);
            editRowBtn.disabled = (selectedRowIdx.size !== 1);
        }
    }
    
    async function handleAddNewRow() {
        if (headersCache.length === 0) {
            alert("Không có dữ liệu (tiêu đề cột) để thêm hàng mới. Vui lòng tải file Excel trước.");
            return;
        }

        const userAddedFileName = "User Added Data";
        let userFile = uploadedFiles.find(f => f.name === userAddedFileName);

        if (!userFile) {
            userFile = { name: userAddedFileName, data: [headersCache] };
            uploadedFiles.push(userFile);
            addFileToList(userAddedFileName, uploadedFiles.length - 1);
        }

        const newRow = Array(headersCache.length).fill('');
        userFile.data.push(newRow);

        await saveDataToFirebase();
        await displayAllData();

        tableContainer.scrollTop = tableContainer.scrollHeight;
        
        const newRowIndexInCurrentData = currentData.length - 1;
        selectedRowIdx.clear();
        selectedRowIdx.add(newRowIndexInCurrentData);
        handleEditRow();
    }

    function handleEditRow() {
        const btn = editRowBtn;

        if (editingRowState.index !== null) {
            const rowIndex = editingRowState.index;
            const tr = tableContainer.querySelector(`tr[data-row-index='${rowIndex}']`);
            if (!tr) return;

            const newRowData = [];
            const cells = tr.querySelectorAll('td');
            const visibleIdx = visibleColumnIndexes();
            
            for (let i = 0; i < cells.length -1; i++) {
                 newRowData.push(cells[i].textContent.trim());
            }

            let fullNewRow = [...currentData[rowIndex]];
            visibleIdx.forEach((originalColIdx, i) => {
                fullNewRow[originalColIdx] = newRowData[i] || '';
            });

            const mapping = rowIndexMap[rowIndex];
            if (mapping) {
                uploadedFiles[mapping.fileIndex].data[mapping.rowIndexInFile] = fullNewRow;
                saveDataToFirebase().then(() => {
                    console.log("Lưu thành công!");
                    currentData[rowIndex] = fullNewRow;
                });
            }

            cells.forEach(td => {
                td.contentEditable = 'false';
                td.classList.remove('editing-cell');
            });
            editingRowState = { index: null, originalData: [] };
            btn.textContent = 'Sửa hàng đã chọn';
            btn.style.background = '#ffc107';
            document.getElementById('cancelEditBtn')?.remove();

        } else {
            if (selectedRowIdx.size !== 1) return;
            const rowIndex = selectedRowIdx.values().next().value;
            const tr = tableContainer.querySelector(`tr[data-row-index='${rowIndex}']`);
            if (!tr) return;

            editingRowState.index = rowIndex;
            editingRowState.originalData = [...currentData[rowIndex]];

            const cells = tr.querySelectorAll('td');
            cells.forEach((td, i) => {
                if (i < cells.length - 1) {
                    td.contentEditable = 'true';
                    td.classList.add('editing-cell');
                }
            });
            cells[0].focus();

            btn.textContent = 'Lưu thay đổi';
            btn.style.background = '#4caf50';
            
            const cancelBtn = document.createElement('button');
            cancelBtn.id = 'cancelEditBtn';
            cancelBtn.textContent = 'Hủy';
            cancelBtn.className = 'export-btn';
            cancelBtn.style.background = '#9e9e9e';
            cancelBtn.onclick = () => {
                const originalTr = tableContainer.querySelector(`tr[data-row-index='${editingRowState.index}']`);
                if(originalTr) {
                     const originalCells = originalTr.querySelectorAll('td');
                     const visibleIdx = visibleColumnIndexes();
                     visibleIdx.forEach((originalColIdx, i) => {
                         originalCells[i].textContent = editingRowState.originalData[originalColIdx] || '';
                     });
                }
                const allCells = originalTr.querySelectorAll('td');
                allCells.forEach(td => {
                    td.contentEditable = 'false';
                    td.classList.remove('editing-cell');
                });
                editingRowState = { index: null, originalData: [] };
                btn.textContent = 'Sửa hàng đã chọn';
                btn.style.background = '#ffc107';
                cancelBtn.remove();
                updateActionButtonsState();
            };
            btn.parentNode.insertBefore(cancelBtn, btn.nextSibling);

        }
        updateActionButtonsState();
    }
    
    async function handleDeleteRows() {
        if (selectedRowIdx.size === 0) return;
        if (!confirm(`Bạn có chắc muốn xóa ${selectedRowIdx.size} hàng đã chọn? Hành động này không thể hoàn tác.`)) return;

        const toDeleteByFile = {};
        for (const rowIndex of selectedRowIdx) {
            const mapping = rowIndexMap[rowIndex];
            if (mapping) {
                if (!toDeleteByFile[mapping.fileIndex]) {
                    toDeleteByFile[mapping.fileIndex] = [];
                }
                toDeleteByFile[mapping.fileIndex].push(mapping.rowIndexInFile);
            }
        }

        for (const fileIndex in toDeleteByFile) {
            toDeleteByFile[fileIndex].sort((a, b) => b - a);
            for (const rowIndexInFile of toDeleteByFile[fileIndex]) {
                uploadedFiles[fileIndex].data.splice(rowIndexInFile, 1);
            }
        }

        selectedRowIdx.clear();
        await saveDataToFirebase();
        await displayAllData();
        updateActionButtonsState();
    }


    // ========== Quản lý hình ảnh ==========
    function openImageManager() {
        if (currentData.length === 0) {
            alert('Vui lòng tải dữ liệu sản phẩm trước.');
            return;
        }
        
        populateProductSelect();
        
        const selectedProduct = productSelect.value;
        if (productImages[selectedProduct]) {
            imageUrlInput.value = productImages[selectedProduct];
            imagePreview.src = productImages[selectedProduct];
            imagePreview.style.display = 'block';
        } else {
            imageUrlInput.value = '';
            imagePreview.style.display = 'none';
        }
        
        currentImageFile = null;
        originalImageFile = null;
        uploadStatus.textContent = '';
        
        resetProcessingUI();
        
        imageManager.style.display = 'block';
    }
    
    function populateProductSelect() {
        productSelect.innerHTML = '';
        
        const productNameIndex = findProductNameColumnIndex();
        if (productNameIndex === -1) {
            alert('Không tìm thấy cột tên sản phẩm trong dữ liệu.');
            return;
        }
        
        const products = new Set();
        const showOnlySelected = showOnlySelectedCheckbox.checked;
        
        for (let i = 1; i < currentData.length; i++) {
            if (showOnlySelected && !selectedRowIdx.has(i)) {
                continue;
            }
            
            const productName = currentData[i][productNameIndex] || '';
            if (productName.trim() !== '') {
                products.add(productName);
            }
        }
        
        if (products.size === 0 && showOnlySelected) {
            alert('Không có sản phẩm nào được chọn. Vui lòng chọn ít nhất một sản phẩm trước.');
            showOnlySelectedCheckbox.checked = false;
            populateProductSelect();
            return;
        }
        
        products.forEach(product => {
            const option = document.createElement('option');
            option.value = product;
            option.textContent = product;
            productSelect.appendChild(option);
        });
    }
    
    function findProductNameColumnIndex() {
        for (let i = 0; i < headersCache.length; i++) {
            const header = headersCache[i].toLowerCase();
            if (header.includes('tên') || header.includes('name') || header.includes('sản phẩm') || header.includes('product')) {
                return i;
            }
        }
        return 0;
    }
    
    function previewImage() {
        const url = imageUrlInput.value.trim();
        if (url) {
            imagePreview.src = url;
            imagePreview.style.display = 'block';
            currentImageFile = null;
            originalImageFile = null;
            uploadStatus.textContent = '';
            resetProcessingUI();
        }
    }
    
    function handleImageUpload(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        if (!file.type.match('image.*')) {
            alert('Vui lòng chọn file hình ảnh (JPEG, PNG, GIF, v.v.)');
            return;
        }
        
        if (file.size > 5 * 1024 * 1024) {
            alert('Kích thước file không được vượt quá 5MB');
            return;
        }
        
        currentImageFile = file;
        originalImageFile = file;
        uploadStatus.textContent = `Đã chọn: ${file.name} (${Math.round(file.size/1024)} KB)`;
        uploadStatus.style.color = '#4CAF50';
        
        removeBgBtn.disabled = false;
        
        const reader = new FileReader();
        reader.onload = function(e) {
            imagePreview.src = e.target.result;
            imagePreview.style.display = 'block';
        };
        reader.readAsDataURL(file);
        
        imageUrlInput.value = '';
    }
    
    function resetImageUpload() {
        if (!confirm('Bạn có chắc muốn xóa hình hiện tại và chọn lại?')) {
            return;
        }
        
        currentImageFile = null;
        originalImageFile = null;
        imageUploadInput.value = '';
        uploadStatus.textContent = '';
        imagePreview.style.display = 'none';
        removeBgBtn.disabled = true;
        
        resetProcessingUI();
        
        triggerUploadBtn.click();
    }
    
    function resetProcessingUI() {
        processingStatus.className = 'processing-status';
        processingStatus.textContent = '';
        removeBgBtn.disabled = (currentImageFile === null);
    }
    
    async function removeImageBackground() {
        if (!currentImageFile) {
            alert('Vui lòng chọn hình ảnh trước.');
            return;
        }
        
        processingStatus.className = 'processing-status loading';
        processingStatus.textContent = 'Đang xử lý tách nền...';
        removeBgBtn.disabled = true;
        
        try {
            const formData = new FormData();
            formData.append('image_file', currentImageFile);
            formData.append('size', 'auto');
            
            const response = await fetch('https://api.remove.bg/v1.0/removebg', {
                method: 'POST',
                headers: { 'X-Api-Key': REMOVE_BG_API_KEY },
                body: formData
            });
            
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.errors ? errorData.errors[0].title : 'Lỗi khi tách nền');
            }
            
            const blob = await response.blob();
            
            const processedFile = new File([blob], `nobg_${currentImageFile.name}`, { type: 'image/png' });
            
            currentImageFile = processedFile;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                imagePreview.src = e.target.result;
                processingStatus.className = 'processing-status success';
                processingStatus.textContent = 'Tách nền thành công!';
                removeBgBtn.disabled = false;
            };
            reader.readAsDataURL(blob);
            
        } catch (error) {
            console.error('Lỗi khi tách nền:', error);
            processingStatus.className = 'processing-status error';
            processingStatus.textContent = `Lỗi: ${error.message || 'Không thể tách nền'}`;
            removeBgBtn.disabled = false;
        }
    }
    
    function saveProductImage() {
        const productName = productSelect.value;
        
        if (!productName) {
            alert('Vui lòng chọn sản phẩm.');
            return;
        }
        
        if (currentImageFile) {
            uploadStatus.textContent = 'Đang xử lý hình ảnh...';
            uploadStatus.style.color = '#FF9800';
            
            const reader = new FileReader();
            reader.onload = function(e) {
                productImages[productName] = e.target.result;
                saveImagesToLocalStorage();
                uploadStatus.textContent = 'Lưu hình ảnh thành công!';
                uploadStatus.style.color = '#4CAF50';
                
                setTimeout(() => {
                    imageManager.style.display = 'none';
                    uploadStatus.textContent = '';
                }, 1000);
            };
            reader.onerror = function(error) {
                console.error('Lỗi đọc file:', error);
                uploadStatus.textContent = 'Lỗi khi xử lý hình ảnh';
                uploadStatus.style.color = '#F44336';
            };
            reader.readAsDataURL(currentImageFile);
        } 
        else if (imageUrlInput.value.trim()) {
            const imageUrl = imageUrlInput.value.trim();
            if (!isValidUrl(imageUrl)) {
                alert('URL hình ảnh không hợp lệ. Vui lòng nhập URL đúng định dạng.');
                return;
            }
            
            productImages[productName] = imageUrl;
            saveImagesToLocalStorage();
            alert('Đã lưu hình ảnh cho sản phẩm: ' + productName);
            imageManager.style.display = 'none';
        }
        else {
            alert('Vui lòng chọn hình ảnh từ máy tính hoặc nhập URL hình ảnh.');
        }
    }
    
    function isValidUrl(string) {
        try { new URL(string); return true; } catch (_) { return false; }
    }
    
    function saveImagesToLocalStorage() {
        try {
            localStorage.setItem("productImages", JSON.stringify(productImages));
        } catch (error) {
            console.error('Lỗi khi lưu hình ảnh:', error);
            alert('Lỗi khi lưu hình ảnh: ' + error.message);
        }
    }
    
    function loadProductImages() {
        try {
            const imagesData = localStorage.getItem("productImages");
            if (imagesData) productImages = JSON.parse(imagesData);
        } catch (error) { console.error("Lỗi khi tải hình ảnh sản phẩm:", error); }
    }

    // ========== Thông báo ==========
    function saveNotification(){
        const notificationText = notificationTextarea.value.trim();
        if(!notificationText){ alert("Vui lòng nhập nội dung thông báo"); return; }
        database.ref("notification").set({ text: notificationText, timestamp: new Date().getTime() })
            .then(() => { notificationDisplay.textContent = notificationText; notificationDisplay.style.display = "block"; notificationDialog.style.display = "none"; })
            .catch((error) => alert("Lỗi khi lưu thông báo: " + error.message));
    }
    function loadNotification(){
        database.ref("notification").once("value").then((snapshot) => {
            const data = snapshot.val(); if (data && data.text){ notificationDisplay.textContent = data.text; notificationDisplay.style.display = "block"; }
        }).catch((error) => console.error("Lỗi khi tải thông báo:", error));
    }

    // ========== Upload/Đọc Excel ==========
    async function handleFileSelect(event){
        const files = event.target.files; if(!files.length) return;
        loadingIndicator.style.display = "block"; tableContainer.innerHTML = "";
        for(let i=0;i<files.length;i++){
            const file = files[i];
            try{
                const data = await readExcelFile(file);
                uploadedFiles.push({ name: file.name, data });
                addFileToList(file.name, uploadedFiles.length - 1);
            }catch(error){ console.error("Lỗi khi đọc file:", file.name, error); alert(`Lỗi khi đọc file ${file.name}: ${error.message}`); }
        }
        updateFileNameDisplay(); displayAllData(); saveDataToFirebase(); loadingIndicator.style.display = "none";
    }
    function readExcelFile(file){
        return new Promise((resolve,reject)=>{
            const reader = new FileReader();
            reader.onload = function(e){
                try{
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: "array", cellStyles: true });
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    let jsonData = XLSX.utils.sheet_to_json(worksheet, { header:1, defval:"", raw:false });
                    jsonData = jsonData.filter(row => row.some(cell => String(cell).trim().length > 0));
                    if(jsonData.length>0){
                        const columnsToKeep = [];
                        const header = jsonData[0];
                        for(let col=0; col<header.length; col++){
                            let columnHasData = false;
                            for(let row=1; row<jsonData.length; row++){
                                if(jsonData[row][col] !== undefined && String(jsonData[row][col]).trim().length>0){ columnHasData = true; break; }
                            }
                            if(columnHasData || (header[col] && String(header[col]).trim().length>0)) columnsToKeep.push(col);
                        }
                        jsonData = jsonData.map(row => row.filter((_,index)=> columnsToKeep.includes(index)));
                    }
                    resolve(jsonData);
                }catch(error){ reject(error); }
            };
            reader.onerror = function(error){ reject(error); };
            reader.readAsArrayBuffer(file);
        });
    }

    // ========== Danh sách file ==========
    function addFileToList(fileName, index){
        const fileItem = document.createElement("div");
        fileItem.className = "file-item";
        fileItem.innerHTML = `<span>${fileName}</span><button class="delete-file-btn" data-index="${index}">Xóa</button>`;
        filesList.appendChild(fileItem);
        fileItem.querySelector(".delete-file-btn").addEventListener("click", (e)=>{
            const indexToRemove = parseInt(e.target.getAttribute("data-index"));
            fileIndexToRemove = indexToRemove; passwordDialog.style.display = "flex"; passwordInput.focus();
        });
    }
    function removeFile(index){
        uploadedFiles.splice(index,1); filesList.innerHTML = "";
        uploadedFiles.forEach((file,i)=> addFileToList(file.name,i));
        updateFileNameDisplay(); displayAllData(); saveDataToFirebase();
    }
    function updateFileNameDisplay(){
        if(uploadedFiles.length===0) fileNameDisplay.textContent = "Chưa chọn file";
        else if(uploadedFiles.length===1) fileNameDisplay.textContent = uploadedFiles[0].name;
        else fileNameDisplay.textContent = `${uploadedFiles.length} file đã chọn`;
    }

    // ========== Hiển thị bảng ==========
    function displayAllData(){
        if (editingRowState.index !== null) {
            handleEditRow();
        }

        if(uploadedFiles.length===0){ tableContainer.innerHTML = '<p>Không có dữ liệu để hiển thị. Vui lòng tải lên file Excel.</p>'; columnToolbar.style.display='none'; return; }
        
        currentData = [];
        rowIndexMap = [];
        let isFirstFile = true;
        
        uploadedFiles.forEach((file, fileIndex) => {
            if (!file.data || file.data.length === 0) return;

            let dataSlice = file.data;
            if (isFirstFile && dataSlice.length > 0) {
                currentData.push(dataSlice[0]);
                rowIndexMap.push({ fileIndex: fileIndex, rowIndexInFile: 0 });
                headersCache = dataSlice[0];
                isFirstFile = false;
            }

            for (let i = 1; i < dataSlice.length; i++) {
                if (dataSlice[i] && dataSlice[i].some(cell => String(cell).trim() !== '')) {
                    currentData.push(dataSlice[i]);
                    rowIndexMap.push({ fileIndex: fileIndex, rowIndexInFile: i });
                }
            }
        });
        
        selectedRowIdx.clear(); showingOnlySelected=false; searchInput.value='';
        createTable(currentData); 
        updateActionButtonsState();
    }

    function visibleColumnIndexes(){
        if (headersCache.length === 0 && currentData.length > 0) {
            headersCache = currentData[0];
        }
        return headersCache.map((_, idx)=> idx).filter(idx => !hiddenColumns.has(idx));
    }

    function createTable(data, sourceIndexes=null){
        if(!data.length){ tableContainer.innerHTML = '<p>Không có dữ liệu để hiển thị.</p>'; columnToolbar.style.display='none'; return; }
        headersCache = data[0] || [];
        const visibleIdx = visibleColumnIndexes();

        renderColumnSelector();

        const table = document.createElement("table"); table.className = "price-table";
        const thead = document.createElement("thead"); const headerRow = document.createElement("tr");
        
        visibleIdx.forEach((colIdx)=>{ 
            const th = document.createElement("th"); th.className = 'th-resizable'; th.textContent = headersCache[colIdx] || ""; 
            if(columnWidths[colIdx]){ th.style.width = columnWidths[colIdx] + 'px'; }
            headerRow.appendChild(th); 
        });
        
        const thChoose = document.createElement('th'); thChoose.textContent = 'Chọn'; thChoose.className='th-resizable'; headerRow.appendChild(thChoose);
        thead.appendChild(headerRow); table.appendChild(thead);

        const tbody = document.createElement("tbody");
        for(let i=1;i<data.length;i++){
            const rowData = data[i] || []; if(!rowData.some(cell=> String(cell).trim().length>0)) continue;
            const tr = document.createElement("tr");
            
            const rowIdx = sourceIndexes ? sourceIndexes[i-1] : i;
            tr.dataset.rowIndex = rowIdx;

            visibleIdx.forEach((colIdx, visPos)=>{
                const td = document.createElement("td"); const cell = rowData[colIdx];
                td.textContent = (typeof cell === 'string' && cell.includes('%')) ? cell : (cell || '');
                if(columnWidths[colIdx]){ td.style.width = columnWidths[colIdx] + 'px'; }
                tr.appendChild(td);
            });
            
            const tdChoose = document.createElement('td');
            const cb = document.createElement('input'); cb.type = 'checkbox'; cb.checked = selectedRowIdx.has(rowIdx);
            cb.addEventListener('change', ()=>{ 
                if (editingRowState.index !== null && editingRowState.index !== rowIdx) {
                    alert("Vui lòng Lưu hoặc Hủy thay đổi ở hàng đang sửa trước khi chọn hàng khác.");
                    cb.checked = !cb.checked;
                    return;
                }
                if(cb.checked) selectedRowIdx.add(rowIdx); else selectedRowIdx.delete(rowIdx); 
                updateActionButtonsState();
            });
            tdChoose.style.textAlign='center'; tdChoose.appendChild(cb); tr.appendChild(tdChoose);

            tbody.appendChild(tr);
        }
        table.appendChild(tbody);
        tableContainer.innerHTML = ""; (tbody.rows.length>0 || headersCache.length>0) ? tableContainer.appendChild(table) : (tableContainer.innerHTML = '<p>Không có dữ liệu để hiển thị sau khi lọc.</p>');

        enableColumnResize(table, visibleIdx);
    }

    function renderSelectedOnly(){
        const indices = Array.from(selectedRowIdx).sort((a,b)=>a-b);
        const aoa = [currentData[0]];
        const sourceIdx = [];
        indices.forEach(idx=>{ 
            if(currentData[idx]) {
                aoa.push(currentData[idx]);
                sourceIdx.push(idx);
            }
        });
        createTable(aoa, sourceIdx);
    }

    function enableColumnResize(table, visibleIdx){
        const headerCells = table.querySelectorAll('thead th');
        headerCells.forEach((th, visPos)=>{
            const isCheckboxCol = (visPos === visibleIdx.length);
            if(isCheckboxCol){ return; }
            let handle = th.querySelector('.col-resizer');
            if(!handle){ handle = document.createElement('div'); handle.className = 'col-resizer'; th.appendChild(handle); }
            const originalIndex = visibleIdx[visPos];
            const minWidth = 60;
            let startX = 0; let startWidth = 0; let dragging = false;

            const onMouseDown = (e)=>{ dragging = true; startX = e.pageX; startWidth = th.offsetWidth; document.body.style.cursor = 'col-resize'; e.preventDefault(); };
            const onMouseMove = (e)=>{
                if(!dragging) return; const delta = e.pageX - startX; let newW = Math.max(minWidth, startWidth + delta);
                columnWidths[originalIndex] = newW; th.style.width = newW + 'px';
                const rows = table.querySelectorAll('tbody tr'); rows.forEach(r=>{ const td = r.children[visPos]; if(td){ td.style.width = newW + 'px'; } });
            };
            const onMouseUp = ()=>{ dragging = false; document.body.style.cursor = ''; };
            handle.onmousedown = onMouseDown; document.addEventListener('mousemove', onMouseMove); document.addEventListener('mouseup', onMouseUp);
        });
    }

    // ========== Tìm kiếm ==========
    function performSearch(){
        const searchTerm = searchInput.value.trim().toLowerCase();
        if(!searchTerm){ createTable(currentData); return; }
        const filtered = [currentData[0]];
        const sourceIdx = [];
        for(let i=1;i<currentData.length;i++){
            const row = currentData[i]; let ok = false;
            for(let j=0;j<row.length;j++){ const v = String(row[j]).toLowerCase(); if(v.includes(searchTerm)){ ok = true; break; } }
            if(ok){ 
                filtered.push(row); 
                sourceIdx.push(i);
            }
        }
        createTable(filtered, sourceIdx); highlightSearchResults(searchTerm);
    }
    function highlightSearchResults(searchTerm){
        if(!searchTerm) return; const table = document.querySelector('.price-table'); if(!table) return;
        const cells = table.querySelectorAll('td');
        cells.forEach(cell=>{ const t = cell.textContent.toLowerCase(); if(t.includes(searchTerm)){ const r = new RegExp(searchTerm,'gi'); cell.innerHTML = cell.textContent.replace(r, m=>`<span class="highlight">${m}</span>`); } });
    }

    // ========== Ẩn/Hiện cột ==========
    function renderColumnSelector(){
        columnList.innerHTML = ""; if(!headersCache.length){ columnToolbar.style.display = 'none'; return; }
        columnToolbar.style.display = 'flex';
        headersCache.forEach((name, idx)=>{
            const chip = document.createElement('label'); chip.className = 'column-chip';
            const cb = document.createElement('input'); cb.type = 'checkbox'; cb.dataset.index = String(idx);
            cb.checked = !hiddenColumns.has(idx);
            const span = document.createElement('span'); span.textContent = name || `Cột ${idx+1}`;
            chip.appendChild(cb); chip.appendChild(span); columnList.appendChild(chip);
        });
    }
    function getSelectedColumnIndexes(){
        return Array.from(columnList.querySelectorAll('input[type="checkbox"]:checked')).map(cb => parseInt(cb.dataset.index));
    }
    function applyColumnSelection(mode){
        const selected = getSelectedColumnIndexes();
        if(!selected.length){ alert('Vui lòng chọn ít nhất một cột.'); return; }
        if(mode === 'hide'){ selected.forEach(idx => hiddenColumns.add(idx)); }
        if(mode === 'unhide'){ selected.forEach(idx => hiddenColumns.delete(idx)); }
        renderColumnSelector(); redrawWithFilters();
    }
    function redrawWithFilters(){
        if(showingOnlySelected){ renderSelectedOnly(); return; }
        const term = searchInput.value.trim(); if(term){ performSearch(); } else { createTable(currentData); }
    }

    // ========== Lưu/Tải Firebase ==========
    async function saveDataToFirebase(){
        const userAddedFile = uploadedFiles.find(f => f.name === "User Added Data");
        if(userAddedFile){
            userAddedFile.data = userAddedFile.data.filter((row, index) => {
                if (index === 0) return true;
                return row.some(cell => String(cell).trim() !== '');
            });
        }

        const dataToSave = { files: uploadedFiles, lastUpdated: new Date().toISOString() };
        try {
            await database.ref("priceData").set(dataToSave);
            console.log("Đã lưu Firebase");
        } catch (err) {
            console.error("Lỗi khi lưu dữ liệu:", err);
            alert("Lỗi khi lưu dữ liệu lên server. Vui lòng kiểm tra kết nối mạng.");
        }
    }
    function loadDataFromFirebase(){
        loadingIndicator.style.display = 'block'; tableContainer.innerHTML = ''; filesList.innerHTML = '';
        database.ref('priceData').once('value').then(snapshot=>{
            const data = snapshot.val();
            if(data && data.files){ 
                uploadedFiles = data.files; 
                filesList.innerHTML = '';
                uploadedFiles.forEach((file,index)=> addFileToList(file.name,index)); 
                updateFileNameDisplay(); 
                displayAllData(); 
            }
            else { tableContainer.innerHTML = '<p>Không có dữ liệu trên server. Vui lòng tải lên file Excel.</p>'; columnToolbar.style.display = 'none'; }
            loadingIndicator.style.display = 'none';
        }).catch(error=>{ console.error('Lỗi khi tải dữ liệu:', error); loadingIndicator.style.display = 'none'; tableContainer.innerHTML = '<p>Lỗi khi tải dữ liệu từ server. Vui lòng thử lại sau.</p>'; });
    }

    // ========== Xuất Excel theo giao diện hiện tại ==========
    function exportCurrentViewToExcel(){
        const table = document.querySelector('.price-table'); if(!table){ alert('Không có dữ liệu để xuất.'); return; }
        const aoa = [];
        const headerCells = table.querySelectorAll('thead tr th');
        const headerRow = Array.from(headerCells).map(th => th.textContent.trim()).slice(0,-1);
        aoa.push(headerRow);
        const bodyRows = table.querySelectorAll('tbody tr');
        bodyRows.forEach(tr => { const row = Array.from(tr.querySelectorAll('td')).map(td => td.textContent.replace(/\u00A0/g,' ').trim()).slice(0,-1); aoa.push(row); });
        const ws = XLSX.utils.aoa_to_sheet(aoa); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, 'BangGia');
        const now = new Date(); const pad = (n)=> String(n).padStart(2,'0');
        const fileName = `BangGia_HienThi_${now.getFullYear()}-${pad(now.getMonth()+1)}-${pad(now.getDate())}_${pad(now.getHours())}${pad(now.getMinutes())}.xlsx`;
        XLSX.writeFile(wb, fileName);
    }

    // ========== Tạo báo giá ==========
    function clearQuoteForm() {
        customerNameInput.value = '';
        customerContactInput.value = '';
        customerPhoneInput.value = '';
        customerAddressInput.value = '';
    }

    function createQuote() {
        const customerName = customerNameInput.value.trim();
        const customerContact = customerContactInput.value.trim();
        const customerPhone = customerPhoneInput.value.trim();
        const customerAddress = customerAddressInput.value.trim();

        if (!customerName) {
            alert('Vui lòng nhập tên khách hàng');
            return;
        }

        quoteCustomerName.textContent = customerName;
        quoteCustomerContact.textContent = customerContact;
        quoteCustomerPhone.textContent = customerPhone;
        quoteCustomerAddress.textContent = customerAddress;

        const now = new Date();
        const day = String(now.getDate()).padStart(2, '0');
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const year = now.getFullYear();
        quoteDate.textContent = `${day}/${month}/${year}`;

        createQuoteTable();

        quotePage.style.display = 'block';
        popupOverlay.style.display = 'none';
        quoteDialog.style.display = 'none';
        clearQuoteForm();
    }

    function createQuoteTable() {
        const indices = Array.from(selectedRowIdx).sort((a,b)=>a-b);
        const aoa = [currentData[0]];
        indices.forEach(idx=>{ if(currentData[idx]) aoa.push(currentData[idx]); });

        const visibleIdx = visibleColumnIndexes();
        const filteredAoa = aoa.map(row => row.filter((_, idx) => visibleIdx.includes(idx)));

        const productNameIndex = findProductNameColumnIndex();
        
        const table = document.createElement("table");
        table.className = "quote-table";

        const thead = document.createElement("thead");
        const headerRow = document.createElement("tr");
        
        const thStt = document.createElement("th");
        thStt.textContent = "STT";
        thStt.style.width = "50px";
        headerRow.appendChild(thStt);
        
        const thImage = document.createElement("th");
        thImage.textContent = "Hình ảnh";
        thImage.style.width = "100px";
        headerRow.appendChild(thImage);

        visibleIdx.forEach(colIdx => {
            const th = document.createElement("th");
            th.textContent = headersCache[colIdx] || "";
            headerRow.appendChild(th);
        });

        thead.appendChild(headerRow);
        table.appendChild(thead);

        const tbody = document.createElement("tbody");
        for (let i = 1; i < filteredAoa.length; i++) {
            const rowData = filteredAoa[i] || [];
            if (!rowData.some(cell => String(cell).trim().length > 0)) continue;

            const tr = document.createElement("tr");

            const tdStt = document.createElement("td");
            tdStt.textContent = i;
            tdStt.style.textAlign = "center";
            tr.appendChild(tdStt);
            
            const tdImage = document.createElement("td");
            tdImage.style.textAlign = "center";
            
            if (productNameIndex !== -1) {
                const productName = aoa[i][productNameIndex] || '';
                if (productImages[productName]) {
                    const img = document.createElement('img');
                    img.src = productImages[productName];
                    img.className = 'product-image';
                    img.alt = productName;
                    tdImage.appendChild(img);
                }
            }
            
            tr.appendChild(tdImage);

            rowData.forEach(cell => {
                const td = document.createElement("td");
                td.textContent = (typeof cell === 'string' && cell.includes('%')) ? cell : (cell || '');
                tr.appendChild(td);
            });

            tbody.appendChild(tr);
        }

        table.appendChild(tbody);
        quoteTableContainer.innerHTML = "";
        quoteTableContainer.appendChild(table);
    }

    // ========== Xuất PDF ==========
    function generatePdf() {
        const printQuotePage = quotePage.cloneNode(true);
        const actionsDiv = printQuotePage.querySelector('.quote-actions');
        if (actionsDiv) {
            actionsDiv.style.display = 'none';
        }
        
        document.body.appendChild(printQuotePage);
        printQuotePage.style.display = 'block';
        printQuotePage.style.position = 'absolute';
        printQuotePage.style.left = '0';
        printQuotePage.style.top = '0';
        printQuotePage.style.zIndex = '9999';
        printQuotePage.style.background = 'white';
        
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('p', 'mm', 'a4');
        
        html2canvas(printQuotePage, {
            scale: 2, useCORS: true, logging: false,
            width: printQuotePage.scrollWidth, height: printQuotePage.scrollHeight
        }).then(canvas => {
            const imgData = canvas.toDataURL('image/jpeg', 1.0);
            const imgWidth = doc.internal.pageSize.getWidth();
            const pageHeight = doc.internal.pageSize.getHeight();
            const imgHeight = canvas.height * imgWidth / canvas.width;
            
            let heightLeft = imgHeight;
            let position = 0;
            
            doc.addImage(imgData, 'JPEG', 0, position, imgWidth, imgHeight);
            heightLeft -= pageHeight;
            
            while (heightLeft >= 0) {
                position = heightLeft - imgHeight;
                doc.addPage();
                doc.addImage(imgData, 'JPEG', 0, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;
            }
            
            document.body.removeChild(printQuotePage);
            
            const now = new Date();
            const fileName = `Bao_Gia_${now.getFullYear()}${(now.getMonth()+1).toString().padStart(2,'0')}${now.getDate().toString().padStart(2,'0')}_${now.getHours().toString().padStart(2,'0')}${now.getMinutes().toString().padStart(2,'0')}.pdf`;
            
            doc.save(fileName);
        }).catch(error => {
            console.error('Lỗi khi tạo PDF:', error);
            if (document.body.contains(printQuotePage)) {
                document.body.removeChild(printQuotePage);
            }
            alert('Có lỗi xảy ra khi tạo PDF. Vui lòng thử lại.');
        });
    }

    // ========== Khởi tạo ==========
    document.addEventListener('DOMContentLoaded', ()=>{ 
        loadNotification(); 
        loadDataFromFirebase();
        loadProductImages();
        loadCustomerDataFromFirebase(); // NEW: Load customer data on start
    });
</script>
</body>
</html>
